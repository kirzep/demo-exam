{% extends 'base.html' %}
{% load static %}

{% block title %}Каталог товаров{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>Список товаров</h2>
    {% if user.is_authenticated and user.role == 'admin' %}
        <a href="{% url 'products:product_create' %}" class="btn-primary" style="margin-left: 20px;">+ Добавить товар</a>
    {% endif %}
</div>

{% if user.is_authenticated and user.role != 'client' %}
<form id="filter-form" style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 5px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
    
    <input type="text" name="q" placeholder="Поиск по товарам..." style="padding: 8px; flex: 1; min-width: 200px;">
    
    <select name="supplier" style="padding: 8px;">
        <option value="all">Все поставщики</option>
        {% for supplier in suppliers %}
            <option value="{{ supplier }}">{{ supplier }}</option>
        {% endfor %}
    </select>

    <select name="sort" style="padding: 8px;">
        <option value="">Без сортировки</option>
        <option value="stock_asc">По количеству (возрастание)</option>
        <option value="stock_desc">По количеству (убывание)</option>
    </select>
</form>
{% endif %}

<div id="product-container" style="display: flex; flex-wrap: wrap; gap: 20px;">
    {% include 'products/product_cards.html' %}
</div>

{% if user.is_authenticated and user.role != 'client' %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById('filter-form');
        const container = document.getElementById('product-container');
        let timeout = null;

        if (!form) return; 

        const fetchProducts = () => {
            const url = new URL(window.location.href);
            const formData = new FormData(form);
            
            for (let [key, value] of formData.entries()) {
                if (value) url.searchParams.set(key, value);
                else url.searchParams.delete(key);
            }

            fetch(url, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(res => res.text())
            .then(html => {
                container.innerHTML = html;
            })
            .catch(err => console.error("Ошибка загрузки:", err));
        };

        form.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(fetchProducts, 300);
        });
    });
</script>
{% endif %}
{% endblock %}